<!DOCTYPE html>
<html lang="en-US">
    <meta charset="utf-8" />
    <meta
        name="viewport"
        content="initial-scale=1, viewport-fit=cover, width=device-width"
    />
    <head>
        <title>preact_template</title>
        <script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>

        <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
        <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
        <style>
            body {
                margin: 0;
                padding: 0;
            }
            #map {
                height: 100vh;
                width: 100vw;
            }
        </style>
    </head>
    <body>
        <script type="module">
            import htm from 'https://esm.sh/htm@3.1.1';
            import { h, Component, render } from 'https://esm.sh/preact@10.13.2';
            import { useState, useLayoutEffect } from 'https://esm.sh/preact@10.13.2/hooks';

            const html = htm.bind(h);

            const MAP_ID = 'map';
            const KEY = 'ffsEnKgX76rALUgJI5PP';

            function renderMap(id) {
                const map = new maplibregl.Map({
                    container: id,
                    style: `https://api.maptiler.com/maps/toner-v2/style.json?key=${KEY}`,
                    center: [-122.4, 37.79],
                    zoom: 15,
                    pitch: 60,
                })
                map.addControl(new maplibregl.NavigationControl(), 'top-right');

                map.on('load', () => {
                    const firstLabelLayerId = map.getStyle().layers.find(layer => layer.type === 'symbol').id;

                    const arcLayer = new deck.MapboxLayer({
                        id: 'deckgl-connections',
                        type: deck.ArcLayer,
                        data: [
                            {source: [-122.3998664, 37.7883697], target: [-122.403068, 37.7930503]}
                        ],
                        getSourcePosition: d => d.source,
                        getTargetPosition: d => d.target,
                        getSourceColor: [255, 0, 128],
                        getTargetColor: [0, 200, 255],
                        getWidth: 8
                    });
                    map.addLayer(arcLayer);

                    map.addLayer(new deck.MapboxLayer({
                        id: 'deckgl-circle',
                        type: deck.ScatterplotLayer,
                        data: [
                            {position: [-122.402, 37.79], color: [255, 0, 0], radius: 1000}
                        ],
                        getPosition: d => d.position,
                        getFillColor: d => d.color,
                        getRadius: d => d.radius,
                        opacity: 0.3
                    }), firstLabelLayerId);
                });
            }

            function App (props) {
                const [count, setCount] = useState(0);

                useLayoutEffect(() => {
                    renderMap(MAP_ID)
                });

                return html`<div>
                    <div id=${MAP_ID} />
                </div>`
            }

            render(html`<${App} name="world" />`, document.body)
        </script>
    </body>
</html>
